/*
 Morfana. JavaScript display engine for morphemic analysis in russian language
 http://morfana.ru
 http://github.com/kityan/morfana

 Copyright 2013, Pavel Kityan (pavel@kityan.ru)
 Licensed under the MIT license.
 Version: 1.0.3a
 Build date: 4 November 2013
*/

(function(s){function x(f,b,d){f.css(b,d);for(var e=f[0].children.length,c=0;c<e;c++)x(jQuery(f[0].children[c]),b,d)}function y(f,b,d,e,c){if(0!=f){if(!d)var k=t(c,f,b,!0);var g=rangy.createRange();g.setStart(e[b-1].obj,e[b-1].index);g.setEnd(e[b-1].obj,e[b-1].index+1);b=document.createElement("span");jQuery(b).css("padding-right",d?"5px":k+"px");jQuery(b).addClass("morfana-paddings");jQuery(b).css({position:"relative",zIndex:v-1});g.surroundContents(b);e=r(c);g=rangy.createRange();g.setStart(e[f-1].obj,e[f-1].index);g.setEnd(e[f-1].obj,e[f-1].index+1);b=document.createElement("span");d&&jQuery(b).css("padding-left","5px");jQuery(b).addClass("morfana-paddings");jQuery(b).css({position:"relative",zIndex:v-1});g.surroundContents(b)}}function t(f,b,d,e){var c=f.html(),k=$('<div style="'+(E?"":"left: -1000px; visibility: hidden; border: 2px solid blue; ")+'width: auto; height: auto; position: absolute;" id="tmpdv" />');f.append(k);k.html(c);f=k.height();x(k,"line-height","normal");var g=k.height();if(e)return k.remove(),g;k.html(c);var c=r(k),a=c.length-1;e=rangy.createRange();d-1<a&&(e.setStart(c[d].obj,c[d].index),e.setEnd(c[a].obj,c[a].index+1),e.deleteContents(),k.find(".morfana-paddings").each(function(){var a=jQuery(this);""==a.text()&&a.remove()}));e.setStart(c[d-1].obj,c[d-1].index);e.setEnd(c[d-1].obj,c[d-1].index+1);c=document.createElement("span");jQuery(c).css("letter-spacing","normal");e.surroundContents(c);a=k.width();1==b?b=0:(c=r(k),e.setStart(c[b-1].obj,c[b-1].index),e.setEnd(c[d-1].obj,c[d-1].index+1),e.deleteContents(),b=k.width());k.remove();return{w:a-b,h:g,x:b,hDiff:f-g}}function r(f){var b=[];(function e(c,f){for(var g=c[0].childNodes.length,a=0;a<g;a++){var l=c[0].childNodes[a].data;if(void 0==l)f=e(jQuery(c[0].childNodes[a]),f);else for(var h=0;h<l.length;h++)b[f]={obj:c[0].childNodes[a],index:h},f++}return f})(f,0);return b}function z(f,b){f?(void 0!=b&&jQuery(f).attr("data-morfana-markup",b),jQuery(f).each(A)):jQuery("[data-morfana-markup]").each(A);u.reverse();B()}function A(){u.push(this)}function B(){var f=u.length;if(0<f){var b=u.pop(),d=jQuery(b),b={};b.obj=d;b.morfems=[];for(var e=d.attr("data-morfana-markup").replace(/\s/g,"").split(";"),d={},c=0,k=e.length;c<k;c++){var g=e[c].split(":");if(g[1]){var a=g[1].split("-"),l=g[0];"ok"==l&&0==a[0]&&(l="nullok");d[l]||(d[l]=[]);d[l][a[0]]||(d[l][a[0]]=[]);d[l][a[0]].push({name:g[0],range:a})}}c=0;for(k=C.length;c<k;c++)if(l=C[c],d[l])for(e=0,g=d[l].length;e<g;e++)if(d[l][e])for(var a=0,h=d[l][e].length;a<h;a++)b.morfems.push(d[l][e][a]);d=b.obj;d.find(".morfana-graphics").remove();d.find(".morfana-paddings").contents().unwrap();c=r(d);k=[];l=t(d,1,c.length+1,!0);for(e=0;e<b.morfems.length;e++){a=b.morfems[e];if("ok"!=a.name)a:{var g=a.name,m=t(b.obj,a.range[0],a.range[1]),a=m.w,h=m.h,n=m.x,m=m.hDiff;switch(g){case "ko":g='<svg class="morfana-graphics"  style="position: absolute; left: '+n+"px; top: "+(0>=m?-(0.75*h):0.5*m-0.75*h)+"px; width: "+a+"px; height: "+h+'px;" xmlns="http://www.w3.org/2000/svg" version="1.1"><path d="M 2 '+(h-2)+" C "+a/3+" "+0.4*h+", "+2*a/3+" "+0.4*h+", "+(a-2)+" "+(h-2)+'" style="stroke:rgb(150,150,150);stroke-width:1.5" fill="transparent"/></svg>';break a;case "su":g='<svg class="morfana-graphics"  style="position: absolute; left: '+n+"px; top: "+(0>=m?-(0.75*h):0.5*m-0.75*h)+"px; width: "+a+"px; height: "+h+'px;" xmlns="http://www.w3.org/2000/svg" version="1.1"><path d="M 2 '+(h-2)+" L "+a/2+" "+0.5*h+" L "+a/2+" "+0.5*h+" L "+(a-2)+" "+(h-2)+'" style="stroke:rgb(150,150,150);stroke-width:1.5" fill="transparent"/></svg>';break a;case "os":g='<svg class="morfana-graphics"  style="position: absolute; left: '+n+"px; top: "+(0>=m?h:0.5*m+h)+"px; width: "+a+"px; height: "+h+'px;" xmlns="http://www.w3.org/2000/svg" version="1.1"><path d="M 1.5 1 L 1.5 '+0.34*h+" L "+(a-1.5)+" "+0.34*h+" L "+(a-1.5)+' 1" style="stroke:rgb(150,150,150);stroke-width:1.5" fill="transparent"/></svg>';break a;case "pr":g='<svg class="morfana-graphics"  style="position: absolute; left: '+n+"px; top: "+(0>=m?-(0.75*h):0.5*m-0.75*h)+"px; width: "+a+"px; height: "+h+'px;" xmlns="http://www.w3.org/2000/svg" version="1.1"><path d="M 2 '+0.5*h+" L "+(a-2)+" "+0.5*h+" L "+(a-2)+" "+(h-2)+'" style="stroke:rgb(150,150,150);stroke-width:1.5" fill="transparent"/></svg>';break a}g=void 0}else{0==a.range[0]?y(c.length,c.length,!1,c,d):y(a.range[0],a.range[1],!0,c,d);c=r(d);g=a.range[0];a=a.range[1];h=!1;0==g&&(g=1,a=c.length,h=!0);var q=t(b.obj,g,a),n=1.4*q.h,m=h?0.3*n+10:q.w+(a==g?10:0),p=h?q.w-0.5*n+3:q.x+(g!=a?5:0),q=q.hDiff;0<a-g&&!h&&(m+=10,p-=5);g='<svg class="morfana-graphics"  style="z-index: '+(v-1)+";position: absolute; left: "+(p-10)+"px; top: "+(0>=q?-(0.13*n):0.5*q-0.13*n)+"px; width: "+m+"px; height: "+n+'px;" xmlns="http://www.w3.org/2000/svg" version="1.1"><path d="M 2.5 '+(n-2)+" L "+(m-3)+" "+(n-2)+" L "+(m-3)+" 2 L 3 2 L 3 "+(n-1.5)+'" style="stroke:rgb(150,150,150);stroke-width:1.5" fill="transparent"/></svg>'}k.push(g)}d.css("display","inline-block");d.css("position","relative");w.freezeWord||(d.css("margin-top",0.75*l+"px"),d.css("margin-bottom",0.35*l+"px"));for(e=0;e<k.length;e++)d.prepend(k[e])}1<f&&setTimeout(B,10)}function F(f){return G[f]}function D(f){for(prop in f){var b=prop.toLowerCase();w[b]=f[prop]}}var E=!1,w={};D({autoStart:!0,freezeWord:!1});var u=[],C="ok pr ko su os nullok".split(" "),G={pr:{name:"\u043f\u0440\u0438\u0441\u0442\u0430\u0432\u043a\u0430"},ko:{name:"\u043a\u043e\u0440\u0435\u043d\u044c"},su:{name:"\u0441\u0443\u0444\u0444\u0438\u043a\u0441"},os:{name:"\u043e\u0441\u043d\u043e\u0432\u0430"},ok:{name:"\u043e\u043a\u043e\u043d\u0447\u0430\u043d\u0438\u0435"}},v=500;if(s.jQuery&&s.rangy){jQuery(document).ready(function(){for(var f=document.getElementsByTagName("script"),b=0,d=f.length;b<d;b++)String(f[b].type).replace(/ /g,"").match(/^text\/x-morfana-config(;.*)?$/)&&(s.eval(f[b].innerHTML),f[b].innerHTML="");rangy.init();w.autostart&&z()});var p={};p.draw=z;p.configure=D;p.getLettersMap=r;p.getMorfemDescription=F;s.Morfana=p}})(window);